<!DOCTYPE html>
<html>
<head>
  <title>reactr</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="css/tachyons.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="libs/jquery.js"></script>
  <script src="libs/lodash.js"></script>
  <script src="libs/react.js"></script>
  <script src="libs/react-dom.js"></script>
  <script src="libs/react-dom-server.min.js"></script>
  <script src="libs/babel.min.js"></script>
  <script src="libs/polyfill.min.js"></script>
  <script src="libs/browser.min.js"></script>
  <script src="libs/ace.js"></script>
</head><body>

<div id="root"></div>

<script id="data" type="text/babel">

window['data'] = {
  name: "Nicolas Martinet",
  contact: [
    {name: "email",  val: "nicolas.martinet@gmail.com"},
    {name: "telephone", val: "123-456-7890"},
    {name: "website", val: "nmartinet.github.io"}
  ],
  skills: {
    title: "Skills",
    content: [
      'excel/vba',
      'html/js/css/react',
      'c#/ruby/python',
      'sql',
      'perfectily bilungual in French and English',
    ]
  },
  education: {
    title: "Education",
    content: [
      {date: '2007/2011', title: 'John Molson School of Business, Concordia University, Montreal, Quebec', desc: 'Bachelor of Commerce, Major in Accountancy'
      },
      {date: '2004/2006', title: 'Collège International Marie de France', desc: 'French Baccalaureate in economics, specialization in mathematics (DEC Equivalent)'
      }
    ]
  },
  profExp: {
    title: "Professional Experience",
    content: [
      {date: '2014/2015', title: 'Ubisoft - IT Dev - Programer Analyst', desc: ''},
      {date: '2011/2014', title: 'Ubisoft - Cost Control - Financial Analyst', desc: ''},
      {date: '2006/2009', 
       title: 'Caisse Centrale Desjardins - Credit and integrated risk management sector' , 
       desc: 'Internship - Main jobs included testing new reports being developed, preparing daily, monthly and quarterly reports, performing quarterly reconciliations at month and quarter end. Automating some reports and jobs through excel templates and VBA, performed some translation from French to English. Various other jobs to alleviate work load for the department and to perform essential services during other employee’s vacations.' }
    ]
  },
  Profile: {
    title: 'About',
  }

};

window['components'] = {
  ReactrRoot: `{
    init: function(){
      var self = this;
      let {data, components} = self.props;

      data.q.registerCallback('onChange', function(data){
        self.setState({data: data});
      });

      components.q.registerCallback('onChange', function(data){
        self.setState({components: data});
      });

      return {
        data: data.data,
        q: data.q,
        components: components.data,
        componentsQ: components.q
      };
    },
    getInitialState: function(){
      return this.init();
    },
    render: function(){
      let {data, q, components, componentsQ} = this.state;
      let {ctrls} = this.props;
      let root = this;

      return (
        <div className="cf">
          <div className="fl w-50">
            <CV data={data} />
          </div>
          <div className="fl w-50 pa3">
            <h1 className="f1 tracked tr fw1 bb bw1 b--silver fw1">reactr</h1>
            <ReactrControls  ctrls={ctrls} data={data} />
            <Tabs selected="1">
              <div label="Data">
                <DataEdit data={data} q={q} path={[]}/>
              </div>

              <div label="Components">
                <ComponentEditor components={components} q={componentsQ} ctrls={ctrls} root={root}/>
              </div>
            </Tabs>
            
          </div>
        </div>
      )
    }
  }`,
  Scratch: `{
    render: function(){
      return (
        <div>
          scratch
          <ToggleMenu>
            <ul>
              <li>1</li>
              <li>1</li>
              <li>1</li>
              <li>1</li>
            </ul>
          </ToggleMenu>
        </div>
      )
    }
  }`,
  ToggleMenu: `{
    toggleVisibility: function(){
      var visible = this.state.visible;

      if (visible) {
        window.removeEventListener('click', this.onClick);
      } else {
        window.addEventListener('click', this.onClick);
      };

      this.setState({visible: !visible}) 
    },
    onClick: function(evnt){ 
      //http://stackoverflow.com/questions/32553158/detect-click-outside-react-component
      var thisNode = ReactDOM.findDOMNode(this)
      if( !thisNode.contains(evnt.target))
        this.toggleVisibility();
    },
    getInitialState: () => ( {visible: false} ),
    render: function(){
      let cnames = cn(
        'relative',
        (this.state.visible ? '' : 'no-display')
      );

      return (
        <div className="">
          <a onClick={this.toggleVisibility}> 
            \u270E
          </a>
          <div className={cn(cnames, 'z-1')}on>
            {this.props.children}
          </div>
        </div>
      )
    }
  }`,
  ComponentEditor: `{
    updateCurrentComponent: function(){
      let {selected, buffer} = this.state;
      let val = this.editor.getValue();
      this.props.ctrls.registerComponent(val, selected );
      this.props.root.forceUpdate();
      this.props.q.updateValue([selected], val);
    },
    newComponent: function(name){
      this.props.q.addKey([], name, "")
      return "";
    },
    setEditOptions: function(option){
      this.editor.setOptions(option)
    },
    onComponentChange: function(key){
      if(this.props.components[this.state.selected] != this.editor.getValue()) {
        var buffer = this.state.buffer;
        buffer[this.state.selected] = this.editor.getValue();
        this.setState({buffer: buffer});
      };

      this.setState({selected: key});
      this.updateEditorValue(key);
    },
    updateEditorValue: function(key){
      var value;
      if(_.has(this.state.buffer, key)){
        value =this.state.buffer[key]; 
      } else {
        value = this.props.components[key]
      }
       this.editor.setValue(value);
    },
    componentDidMount: function(){
      this.editor = ace.edit('editor');
      this.editor.setTheme("ace/theme/clouds");
      this.editor.getSession().setMode("ace/mode/javascript");
      this.editor.$blockScrolling = Infinity;
      this.editor.setShowPrintMargin(false);
      this.setEditOptions({
        minLines: 25,
        maxLines: 50,
        fontSize: "14pt",
      })
      this.editor.setValue(this.props.components[this.state.selected]);
    },
    getInitialState: function(){
      return {
        selected: _.keys(this.props.components)[0],
        buffer: {},
      }
    },
    render: function(){
      var self = this;
      let {components} = self.props;
      let buffer = self.state.buffer;

      return (
        <div className="dt w-100">
          <div className="dtc w-25">
            <ComponentList 
              components={components} 
              selected={self.state.selected}
              buffer={buffer} 
              onClick={this.onComponentChange} 
              newComponent={this.newComponent}/>
          </div>
          
          <div className="dtc w-75 pl3 pt3">
            <ComponentEditorFileControls 
              updateComponent={self.updateCurrentComponent}  
              setOption={self.setEditOptions}/>
            
            <div id="editor">
            </div>
          
          </div>
        </div>
      )
    },
  }`,
  ComponentEditorFileControls: `{
    onApply: function(){
      this.props.updateComponent();
    },
    setFontSize: function(size){
      this.props.setOption({fontSize: size});
    },
    render: function(){
      let self = this;
      let itmClass = "f6 f5-ns b db pa2 link dim dark-gray ba b--black-20";

      let fontSizes = _.map(_.range(12, 18), (n) => n+"pt" );

      let listCn = "dib mb1 mr3"

      return (
        <ul className="list ma0 pl0 pb2">
          <li className={listCn}>
            <a href="#" className={itmClass} onClick={self.onApply}>
              Apply
            </a>
          </li>

          <li className={listCn}>
            <div className="f6 b">
              font size
            </div>
            <div>
              <Dropdown 
                options={fontSizes}
                value={fontSizes[0]}
                onChange={self.setFontSize}/>
            </div>
          </li>

        </ul>
      )
    },
  }`,
  ComponentList: `{
    onClick: function(key, evnt){
      evnt.preventDefault();
      this.props.onClick(key);
    },
    newComponent: function(name){
      this.props.newComponent(name)
      return "";
    },
    render: function(){
      var self = this;
      let {components, buffer} = self.props;

      var compList = _.map(components, function(comp, key){
        let modIndic = _.has(buffer, key) ? '\u2022' : "";
        let cNames = cn(
          "ph3 pv3 bb b--light-silver",
          (key == self.props.selected) ? 'b' : ''
        );
        return (
          <li className={cNames} key={key} onClick={self.onClick.bind(self, key)}>{key}{modIndic}</li>
        )
      })

      return (
        <div>
          <TextInputButton onClick={this.newComponent} placeholder="new component" buttonValue="add"/>
          <ul className="list pl0 ml0 center mw6 ba b--light-silver br2">
            {compList}
          </ul>
        </div>
        
      );
    }
  }`,
  TextInputButton: `{
    onChange: function(evnt){
      this.setState({value: evnt.target.value})
    },
    onClick: function(evnt){
      this.setState({value: this.props.onClick(this.state.value)});
    },
    getInitialState: function(){
      return {value: this.props.value || ""};
    },
    render: function(){
      return (
        <div>
          <input className="inpt" 
                     type="text" 
                     value={this.state.value} 
                     onChange={this.onChange}
                     placeholder={this.props.placeholder}/>
          <button className="btn" onClick={this.onClick}>
            {this.props.buttonValue || "ok"}
          </button>
        </div>
      )
    }
  }`,
  ReactrControls: `{
    onSave: function(e){
      this.props.ctrls.saveToFile();
    },
    onSaveStatic: function(e){
      this.props.ctrls.saveStaticDoc();
    },
    pData: function(){
      console.log(this.props.data)
    },
    render: function(){
      let btnClass="btn fr ml2";
      return (
        <div className="cf">
          <button className={btnClass} onClick={this.onSave} >
            Save
          </button>
          <button className={btnClass} onClick={this.onSaveStatic}>
            Save static doc
          </button>
          <button className={btnClass} onClick={this.pData}>
            debug data
          </button>
        </div>
      )
    }
  }`,
  Tabs: `{
    getInitialState: function(){
      return {
        selected: this.props.selected || 0
      };
    },
    onClick: function(indx, evnt){
      evnt.preventDefault();
      this.setState({selected: indx})

    },
    render: function(){
      var self = this;

      var tabList = _.map(self.props.children, function(child, index){
        var  cNames = "link dim black f1 dib mr5";
        if (index == self.state.selected)
          cNames += " bb bw2 b--silver "

        return (
          <a className={cNames} key={index} href="#" onClick={self.onClick.bind(self, index)}>
            {child.props.label}
          </a>
        )
      })
      var content = self.props.children[self.state.selected];

      return (
        <div className="nowrap overflow-x-auto">
          <div className="bb bw1 b--silver mb2">
            {tabList}
          </div>
          <div className="pa3 pt1">
            {content}
          </div>
          
        </div>
      )
    }
  }`,
  DataEdit: `{
    render: function(){
      var self = this;
      let {data, q, path} = self.props;

      var Editor = React.createElement(window[q.getType(path) + "Editor"], {data: data, q: q, path: path });
      
      return (
        <div>
          {Editor}
        </div>
      )
    }
  }`,
  ObjectEditor: `{
    addArray: function(path, evnt){
      console.log(path)
      this.props.q.addArray(path);
    },
    modKey: function(path, newVal, evnt){
      this.props.q.modKey(path, newVal);
      return newVal
    }, 
    addKey: function(path, newVal, evnt){
      this.props.q.addKey(path, newVal);
      return "";
    },
    deleteKey: function(path, evnt){
      if (window.confirm("Delete key?")) {
        this.props.q.delKey(path);
      };
      
    },
    changeKeyType: function(path, newType, evnt){
      if (window.confirm("Change type? value will be deleted")){
        this.props.q.changeType(path, newType)
      };
    },
    getOptsMenu: function(path){
      let self = this;
      let {q} = self.props;

      let dType = q.getType(path);
      let types = q.getTypes();

      let opts = [
        (<a onClick={self.deleteKey.bind(self, path)}>Delete</a>),
        (<div>
          Data type: <Dropdown options={_.keys(types)} value={dType} onChange={self.changeKeyType.bind(self, path)} />
         </div>
        ),
      ];

      if (dType == "Array") {
        opts.push(
          <a>Add entry</a>
        )
      };

      let optsUI = _.map(opts, (opt) => {
        return (
          <li>
            {opt}
          </li>
        )
      })

      return (
        <div className="ba b--silver bg-white pa2 ma0">
          <h3 className="mt0">Properties</h3>
          <ul className="list pl0">
            {optsUI}
          </ul>
        </div>
      );
    },
    render: function(){
      var self = this;
      let {data, q, path} = self.props;


      var keyVal = _.map(data, function(val, key){
        var _path = path.concat(key)
        let optsMenu = self.getOptsMenu(_path);

        return (
          <div key={key} className="cf">
            <div className="cf w-100">
              <div className="fl w-25">
                <TextInput val={key} 
                           placeholder={key} 
                           onSave={self.modKey}
                           ctrls={optsMenu}
                           path={_path} />        
              </div>
              <div className="fr w-75">
                <DataEdit data={val} q={q} path={_path} />
              </div>
            </div>
          </div>
        );
      });

      return (
        <div className="w-100">
          {keyVal}
          <div className="w-25">
            <TextInput val="" placeholder="new key" onSave={this.addKey} path={path}/>
          </div>
        </div>
      );
    },
  }`,
  TextInput: `{
    onChange: function(e){
      this.setState({val: e.target.value});
      if(e.target.value === this.props.data){
        this.setState({mod: false});
      } else {
        this.setState({mod: true});
      }
    },
    onSave: function(e){
      let newVal = this.props.onSave(this.props.path, this.state.val);
      this.setState({val: newVal, mod:false});
    },
    onMouseOver: function(e){
      this.setState({hover: true});
    },
    onMouseOut: function(e){
      this.setState({hover: false});
    },
    onFocus: function(e){
      this.setState({focused: true});
    },
    onBlur: function(e){
      this.setState({focused: false});
    },
    getInitialState: function(){
      return {
        val: this.props.val || "",
        mod: false,
        hover: false,
        focused: false,
      };
    },
    render: function(){
      var saveCtrls;
      if (this.state.mod && !(this.state.val === "")) {
        saveCtrls = (
          <a className="fl" onClick={this.onSave}>
            \u2713
          </a>
        )
      };
      
      let {hover, focused} = this.state;

      let propsBtn = cn(
        "fl dib absolute f8",
        (hover || focused ? '' : 'no-display')
      );

      let ctrls;
      if (this.props.ctrls) {
        ctrls = (
          <div className="fl">
            <ToggleMenu>
              {this.props.ctrls}
            </ToggleMenu>
          </div>
        ) 
      };

      return(
        <div className="cf mr3 relative pr3">
          <div className="w-100 fr dib">
            <input className="inpt w-100 tr" 
                   type="text" 
                   value={this.state.val} 
                   onChange={this.onChange}
                   onMouseOver={this.mouseOver}
                   onMouseOut={this.mouseOut}
                   onFocus={this.onFocus}
                   onBlur={this.onBlur}
                   placeholder={this.props.placeholder}/>
          </div>
          <div className="fl cf absolute f8">
            {ctrls}
            {saveCtrls}
          </div> 
        </div>
      )
    },
  }`,
  ArrayEditor: `{
    render: function(){
      var self = this;
      let {data, q, path} = self.props;

      var getRowClass = function(index){
        if(index%2==0){
          return {
            row: "bg-black-10",
            num: "black-10"
          }
        }else{
          return {
            row: "bg-black-20",
            num: "black-10"
          }
        }
      }

      var itmList = _.map(data, function(val, index){
        var _path = path.concat(index);
        let {row, num} = getRowClass(index);

        return (
          <div className="cf w-100 relative" key={index}>
            <div className={"fl absolute w-auto f1 fw1 b ma1 " + num}>
              {index}
            </div>
            <div className={"fl w-100 pa1 " + row}>
              <DataEdit data={val} q={q} path={_path} />
            </div>
          </div>
        )
      });

      return (
        <div className="ma1 ba bw1 b--silver">
          {itmList}
        </div>
      )

    },
  }`,
  ValueEditor:  `{
    onChange: function(e){
      this.setState({val: e.target.value})
      this.props.q.updateValue(this.props.path, e.target.value)
    },
    getInitialState: function(){
      return {
        val: this.props.data || ""
      }
    },
    render: function(){
      var types = _.keys(this.props.q.getTypes());
      return (
        <div className="cf w-100">
          <div className="fl w-100">
            <input className="w-100 inpt" type="text" value={this.state.val} onChange={this.onChange} />
          </div>
        </div>
      )
    }
  }`,
  Dropdown: `{
    onChange: function(e){
      this.setState({value: e.target.value});
      this.props.onChange(e.target.value);
    },
    getInitialState: function(){
      return {
        value: this.props.value || null
      }
    },
    render: function(){
      var options = _.map(this.props.options, function(o, i){
        return (
          <option key={i} value={o}>{o}</option>
        )
      });

      return (
        <select className="inpt" onChange={this.onChange} value={this.state.value}>
          {options}
        </select>
      )
    },
  }`,
  CV: `{
    render: function(){
      let {data} = this.props;
      return (
        <div className="mw9 center pa3 ph5-ns">
          <CVHeader name={data.name}/>
          <ContactBox contactInfo={data.contact} />
          <CVSection title={data.skills.title}>
            <VList elems={data.skills.content} />
          </CVSection> 
          <CVSection title={data.education.title}>
            <ChronoList elems={data.education.content} />
          </CVSection>
          <CVSection title={data.profExp.title} >
            <ChronoList elems={data.profExp.content} />
          </CVSection>
        </div>
      )
    },
  }`,
  CVHeader: `{
    render: function() {
      let {name} = this.props;
      return (
        <div className="bb bw1 mb4" >
          <h1 className="f1 fw1 tracked tr mb0">{name}</h1>
        </div>
      );

    }
  }`,
  ContactList: `{
    render: function(){
      let contact = _(this.props.contactInfo)
        .map( (info) => info.val )
        .reduce( (info, accum) => info + " // " + accum )

      return (
        <div className="fr">
          {contact}
        </div>
      )
    }
  }`,
  ContactBox: `{
    render: function() {
      let {contactInfo} = this.props;

      var boxContent = contactInfo.map(function(info){
        return (
          <li key={info.name} className="cf f5 pb3">
            <div className="fl">{info.name}</div>
            <div className="fr">{info.val}</div>
          </li>  
        );
      })

      return (
        <div className="w-25 ba bw1 b--light-silver fr pa3 dib">
          <h2 className="f3 mt0 tc">Contact Information</h2>
          <ul className="list pa0 ma0">
            {boxContent}
          </ul>
        </div>
      )

    }
  }`,
  CVSection: `{
    render: function(){
      return (
        <div className="fl">
          <h2 className="tl f2 fw5 mb2 mt0">
            {this.props.title}
          </h2>
          {this.props.children}
        </div>
      )
    }
  }`,
  VList: `{
    render: function(){
      let listElems = _.map(this.props.elems, function(elem, i){
        return <li key={i} className="f4 mb2">{elem}</li>
      })
      return (
        <ul className="list pa0 ma0 pb2 mb2 pl4">
          {listElems}
        </ul>
      )
    }
  }`,
  ChronoList: `{
    render: function(){
      let listElems = _.map(this.props.elems, function(elem, i){
        return (
          <li key={i} className="cf w-100 mb3">
            <div className="fl w-10 tc b pr2">{elem.date}</div>
            <div className="fl w-25 i pr4">{elem.title}</div>
            <div className="fl w-50">{elem.desc}</div>
          </li>
        )
      })
      return (
        <ul className="cf w-100 list pa0 mb0 pl4">
          {listElems}
        </ul>
      )
    }
  }`,

};

window['config'] = {
  elem:         'root',
  data:         'data',
  docRoot:      'CV',
  components:   'components',
  title:        'reactr',
  stylesheets:  ["css/tachyons.min.css",  
                  "css/style.css", 
                ],
  scripts:      [ "libs/jquery.js",
                  "libs/lodash.js",
                  "libs/react.js",
                  "libs/react-dom.js",
                  "libs/react-dom-server.min.js",
                  "libs/babel.min.js",
                  "libs/polyfill.min.js",
                  "libs/browser.min.js",
                  "libs/ace.js",
                ],
  datasets:     [{name: 'data',       type: 'data'},
                 {name: 'components', type: 'components' },
                ],
}

</script>


<script id="reactr" type="text/babel">
  var cn = function(){
    return _.chain(arguments)
            .flattenDeep()
            .map(function(d){
              if(typeof(d) == 'object')
                return _.map(d, function(v, k){
                  return v ? k : '';
                })
              return d;
            })
            .flattenDeep()
            .reduce(function(d, a){
              return d + " " + a;
            })
            .value()
  }

  var ils = function(){

    return arguments
  }

  var Container = function(data){
    var self = this;
    var data = data;
    var functions = {};
    var callbacks = {
      'onChange': [],
    };

    var types = {
      'Object': {},
      'Array': [],
      'Value': '',
    }

    var registerCallback = function(evnt, cb){
      if(!_.has(callbacks, evnt)) callbacks[evnt] = [];
      callbacks[evnt].push(cb);    
    };

    var trigger = function(evnt, arg){
      var _arg = arg;
      if(_.has(callbacks, evnt))
        _.forEach(callbacks[evnt], function(cb){
          cb(_arg);
        })
    };

    var doOn = function(path, cb){
      var _doOn = function(data, path, cb){
        if(path.length == 0) return cb(data);
        var _path = path.slice();
        var key = _path.shift();
        data[key] = _doOn(data[key], _path, cb);

        return data
      }
      data = _doOn(data, path, cb);
      trigger('onChange', data)
    };

    var readOn = function(path){
      var _readOn = function(data, path){
        if(path.length == 0) return data;
        var _path = path.slice();
        var key = _path.shift();
        return _readOn(data[key], _path); 
      };

      return _readOn(data, path);
    };

    var getType = function(path){
      var _getType = function(v){
        if ((typeof(v) === 'object') && !Array.isArray(v)) return 'Object';
        if (Array.isArray(v)) return 'Array';
        return 'Value';
      }

      return _getType(readOn(path))
    };

    var changeType = function(path, newType){
      var newValue = types[newType];
      doOn(path, function(d){
        return newValue;
      })
    };

    var updateValue = function(path, value){
      var value = value;
      doOn(path, function(d){
        return value;
      });
    };

    var addKey = function(path, key, newValue){
      var value = newValue || types['Object'];
      var key = key
      doOn(path, function(d){
        return _.extend(d, {[key.toString()]: value});
      })
    };

    var modKey = function(path, key){
      var path = path;
      var oldKey = path.pop();
      var newkey = key;
      doOn(path, function(d){
        d[newkey] = d[oldKey];
        delete d[oldKey];
        return d;
      });
    };

    var delKey = function(path){
      var path = path;
      var key = path.pop();
      doOn(path, function(d){
        delete d[key];
        return d;
      })
    };

    var addArray = function(path){
      doOn(path, function(d){
        d.push("")
        return d;
      })
    };

    var getTypes = function(){
      return types
    }
   
    var init = function(){

    };

    functions = {
      doOn: doOn,
      readOn: readOn,
      updateValue: updateValue,
      registerCallback: registerCallback,
      getType: getType,
      getTypes: getTypes,
      addKey: addKey,
      modKey: modKey,
      delKey: delKey,
      addArray: addArray,
      changeType: changeType,
    }

    init();

    return {
      data: data,
      q: functions,
    }
  };



  var Reactr = function(){
    var self        = this;
    var config;
    var configContainer = {}
    var datasets        = {};
    var components      = {};
    var ctrls           = {};

    var promptForSave = function(content){
      var el = document.createElement('a');
      el.setAttribute('href', 
                      'data:text/plain;charset=utf-8,' 
                      + encodeURIComponent(content));
      
      el.setAttribute('download', 'index.html');
      el.style.display = 'none';

      document.body.appendChild(el);
      el.click();
      document.body.removeChild(el);
    };

    var getReactrCode = function(){

      return $('html').find('#reactr').html();
    }

    var generateFile = function(content){
      //defaults
      let {
        title       = 'reactr',
        meta        = `<meta charset="utf-8" />`,
        stylesheets = [],
        scripts     = [],
        datasets    = [], 
      } = content;

      let reactrCode = `<script id="reactr" type="text/babel">` + getReactrCode() + "</" + "script>";

      let cssImports = _(stylesheets)
                          .map((ss) => `<link rel="stylesheet" href="${ss}">`)
                          .reduce((x, a) => `${x} \n        ${a}`);

      //split closing tag - browser would interpret it as the closing tag of the 
      //current scirpt instead of a template
      let scriptImports = _(scripts)
                            .map((sf) => `<script src="${sf}">` + "</" + "script>")
                            .reduce((x, a) => `${x} \n        ${a}`);


      let dsString = function(dataset){
        let content = `window['${dataset.name}'] = ${JSON.stringify(dataset.data)} ;`;
        return `<script id="${dataset.name}" type="text/babel">` + content + "</" + "script>"
      };
      let inlineData = _(datasets).map(dsString).reduce( (d, a) => `${d} \n ${a}` )                          

      let fileContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${title}</title>
          ${meta}
          ${cssImports}
          ${scriptImports}
        </head>
        <body>
          <div id="root"></div>
          ${inlineData}
          ${reactrCode}
        </body>
        </html>
      `

      return  fileContent
    }

    var saveToFile = function(){
      let currConf = configContainer.data



      let fileContent = {
        title:        currConf.title,
        stylesheets:  currConf.stylesheets,
        scripts:      currConf.scripts,
        //get data here
        datasets:     [{name: 'config',     data: currConf},
                       {name: 'data',       data: data.data},
                       {name: 'components', data:components.data },
                      ],
                       
      }

      promptForSave(generateFile(fileContent))
    };

    var generateStaticDoc = function(content){
      //defaults
      let {
        title       = 'reactr',
        meta        = `<meta charset="utf-8" />`,
        stylesheets = [],
        body        = ""
      } = content;

      let cssImports = _(stylesheets)
                          .map((ss) => `<link rel="stylesheet" href="${ss}">`)
                          .reduce((x, a) => `${x} \n        ${a}`);


      let fileContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${title}</title>
          ${meta}
          ${cssImports}
        </head>
        <body>
          ${body}
        </body>
        </html>
      `

      return  fileContent
    }



    var saveStaticDoc = function(){
      let currConf = configContainer.data;
      let body = ReactDOMServer.renderToString(
        React.createElement(window[currConf.docRoot], {data: data.data})
      )
      
      let fileContent = {
        title:        currConf.title,
        title:        currConf.title,
        stylesheets:  currConf.stylesheets,
        body:         body

      };

      promptForSave(generateStaticDoc(fileContent))


    };

    var registerComponent = function(component, name){
      var presets = { presets: ['es2015', 'react'] };
      var compCode = "window['" + name + "'] = React.createClass(" + component + ")";
      compCode = Babel.transform(compCode, presets).code;

      eval(compCode)
    };

    var registerComponents = function(components){
      _.forEach(components, registerComponent);
    }; 

    var init = function(){
      config = window["config"];

      _(config.datasets)
        .filter({type: 'components'})
        .forEach(function(comp){
          registerComponents(window[comp.name]);
          components = Container(window[comp.name]);
        })

      _(config.datasets)
        .filter({type: 'data'})
        .forEach(function(ds){
          data = Container(window[ds.name]);
        });

      configContainer = Container(config);
    };

    init();

    ctrls = {
      registerComponent: registerComponent,
      saveToFile: saveToFile,
      saveStaticDoc: saveStaticDoc,
    }

    var run = function(){
      const rootElement = document.getElementById(config.elem)

      let props = {};

      ReactDOM.render(
        <ReactrRoot data={data} components={components} ctrls={ctrls} />,
        rootElement
      );
    };

    return {
      run: run,
    }

  }

  var reactr = Reactr();

  reactr.run();

</script>




</body></html>
